<!DOCTYPE html>
<html lang="zh-TW" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Taiwan Investment Command Center</title>
    
    <!-- æ ¸å¿ƒå¥—ä»¶ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #f3f6f9; --bg-card: #ffffff; --text-primary: #1e293b; --accent-color: #2563eb; --sidebar-width: 280px;
        }
        [data-bs-theme="dark"] {
            --bg-body: #0f172a; --bg-card: #1e293b; --text-primary: #e2e8f0; --accent-color: #3b82f6;
        }
        body { background-color: var(--bg-body); color: var(--text-primary); font-family: 'Noto Sans TC', sans-serif; transition: 0.3s; }
        .ticker-tape { height: 50px; width: 100%; position: fixed; top: 0; z-index: 1030; }
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; top: 50px; left: 0; background: var(--bg-card); border-right: 1px solid rgba(128,128,128,0.1); padding: 20px; overflow-y: auto; z-index: 1020; transition: 0.3s; }
        .main-wrapper { margin-left: var(--sidebar-width); margin-top: 50px; padding: 25px; transition: 0.3s; }
        .pro-card { background: var(--bg-card); border-radius: 12px; padding: 20px; border: 1px solid rgba(128,128,128,0.1); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); height: 100%; }
        .mono-font { font-family: 'JetBrains Mono', monospace; letter-spacing: -0.5px; }
        .progress-bar { transition: width 1.5s ease-in-out; }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 280px; top: 0; height: 100%; z-index: 1050; }
            .sidebar.show { transform: translateX(0); }
            .main-wrapper { margin-left: 0; padding: 15px; margin-top: 50px; }
            .ticker-tape { top: 50px; }
            .mobile-nav { display: flex !important; }
        }
        .mobile-nav { display: none; height: 50px; background: var(--bg-card); position: fixed; top: 0; width: 100%; z-index: 1040; align-items: center; padding: 0 15px; border-bottom: 1px solid rgba(128,128,128,0.1); }
        .news-btn { text-decoration: none; color: inherit; transition: 0.2s; }
        .news-btn:hover { opacity: 0.8; transform: translateY(-2px); }
    </style>
</head>
<body>

<div class="mobile-nav justify-content-between">
    <span class="fw-bold">ğŸ‡¹ğŸ‡¼ å°è‚¡æˆ°æƒ…å®¤</span>
    <button class="btn btn-sm btn-outline-secondary" onclick="toggleSidebar()"><i class="bi bi-list"></i></button>
</div>

<!-- ä¿®æ­£è·‘é¦¬ç‡ˆï¼šæ”¹ç”¨ TVC æ•¸æ“šæºï¼Œè§£æ±ºç´…è‰²é©šå˜†è™Ÿå•é¡Œ -->
<div class="ticker-tape d-none d-md-block">
    <div class="tradingview-widget-container">
        <div class="tradingview-widget-container__widget"></div>
        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
        {
        "symbols":[
            {"proName":"TVC:TAIEX","title":"å°ç£åŠ æ¬ŠæŒ‡æ•¸"},
            {"proName":"TVC:TPEX","title":"æ«ƒè²·æŒ‡æ•¸"},
            {"proName":"TWSE:2330","title":"å°ç©é›»"},
            {"proName":"FX_IDC:USDTWD","title":"USD/TWD"},
            {"proName":"FOREXCOM:SPXUSD","title":"S&P 500"},
            {"proName":"FOREXCOM:NSXUSD","title":"Nasdaq 100"}
        ],
        "showSymbolLogo":true,
        "colorTheme":"light",
        "isTransparent":false,
        "displayMode":"adaptive",
        "locale":"zh_TW"
        }
        </script>
    </div>
</div>

<div class="sidebar" id="sidebar">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="fw-bold mb-0">ğŸ›ï¸ æ§åˆ¶ä¸­å¿ƒ</h5>
        <button class="btn btn-sm btn-outline-secondary d-md-none" onclick="toggleSidebar()">âœ•</button>
    </div>
    
    <button class="btn btn-outline-primary w-100 mb-4" onclick="toggleTheme()"><i class="bi bi-moon-stars-fill"></i> åˆ‡æ›æ·±è‰²æ¨¡å¼</button>

    <div class="mb-3">
        <label class="form-label small text-muted fw-bold">æ•¸æ“šä¾†æº (CSV URL)</label>
        <input type="text" class="form-control form-control-sm" id="sheetUrl">
    </div>
    <button class="btn btn-primary btn-sm w-100 mb-4" onclick="loadData()">ğŸ“¥ æ›´æ–°æˆ°æƒ…æ•¸æ“š</button>

    <hr>
    <h6 class="fw-bold text-muted small">ğŸ¯ è²¡å¯Œè‡ªç”±ç›®æ¨™ (FIRE)</h6>
    <div class="mb-2"><label class="small text-muted">ç›®æ¨™é‡‘é¡</label><input type="number" id="fireGoal" class="form-control form-control-sm" value="20000000" onchange="updateFireProgress()"></div>
    <div class="progress mb-2" style="height: 10px;"><div id="fireProgressBar" class="progress-bar bg-success" style="width: 0%"></div></div>
    <div class="d-flex justify-content-between small"><span class="text-muted">é€²åº¦</span><span class="fw-bold" id="firePercent">0%</span></div>

    <hr>
    <h6 class="fw-bold text-muted small">ğŸ”® æœªä¾†æ¨æ¼”</h6>
    <div class="row g-2 mb-2">
        <div class="col-6"><label class="small text-muted">æœˆæŠ•</label><input type="number" id="monthlyContribute" class="form-control form-control-sm" value="10000"></div>
        <div class="col-6"><label class="small text-muted">å ±é…¬%</label><input type="number" id="annualReturn" class="form-control form-control-sm" value="8"></div>
    </div>
    <button class="btn btn-success btn-sm w-100 mb-4" onclick="calculateProjection()">æ¨æ¼”è³‡ç”¢èµ°å‹¢</button>

    <h6 class="fw-bold text-muted small">ğŸ“… å…¨çƒè²¡ç¶“æ—¥æ›†</h6>
    <div class="tradingview-widget-container" style="height: 300px; overflow: hidden; border-radius: 8px;">
        <div class="tradingview-widget-container__widget"></div>
        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-events.js" async>
        {"colorTheme":"light","isTransparent":true,"width":"100%","height":"100%","locale":"zh_TW","importanceFilter":"-1,0,1"}
        </script>
    </div>
</div>

<div class="main-wrapper">
    <div class="row g-3 mb-4">
        <div class="col-md-3 col-6">
            <div class="pro-card border-start border-4 border-primary">
                <div class="text-muted small fw-bold text-uppercase">Total Assets</div>
                <div class="kpi-value fs-3 fw-bold mono-font" id="totalAssets">0</div>
                <div class="small text-muted">TWD</div>
            </div>
        </div>
        <div class="col-md-3 col-6">
            <div class="pro-card border-start border-4 border-danger" id="pnlCard">
                <div class="text-muted small fw-bold text-uppercase">Total P&L</div>
                <div class="kpi-value fs-3 fw-bold mono-font" id="totalProfit">0</div>
                <div class="small fw-bold" id="profitPct">0%</div>
            </div>
        </div>
        <div class="col-md-3 col-6">
            <div class="pro-card border-start border-4 border-warning">
                <div class="text-muted small fw-bold text-uppercase">Est. Annual Dividend</div>
                <div class="kpi-value fs-3 fw-bold mono-font text-warning" id="totalDividend">0</div>
                <div class="small text-muted">Yield: <span id="avgYield">0</span>%</div>
            </div>
        </div>
        <div class="col-md-3 col-6">
            <div class="pro-card p-0 overflow-hidden">
                <div class="tradingview-widget-container">
                    <div class="tradingview-widget-container__widget"></div>
                    <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js" async>
                    {"symbol":"CBOE:VIX","width":"100%","height":"100%","locale":"zh_TW","dateRange":"1M","colorTheme":"light","isTransparent":true,"autosize":true,"largeChartUrl":""}
                    </script>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="pro-card">
                <h6 class="fw-bold mb-3"><i class="bi bi-pie-chart-fill"></i> è³‡ç”¢é…ç½®</h6>
                <div style="height: 250px;"><canvas id="allocationChart"></canvas></div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="pro-card text-center d-flex flex-column justify-content-center">
                <h6 class="fw-bold mb-3 text-muted">ğŸ’¸ è¢«å‹•æ”¶å…¥ (æœˆè–ªåŒ–)</h6>
                <div class="display-5 fw-bold text-success mono-font" id="monthlyPassive">0</div>
                <div class="text-muted small mb-3">TWD / Month</div>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-success" id="passiveProgress" style="width: 0%"></div>
                </div>
                <div class="small text-muted mt-2">ç›®æ¨™: 50,000 / æœˆ (é€²åº¦ <span id="passivePct">0</span>%)</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="pro-card">
                <h6 class="fw-bold mb-3"><i class="bi bi-graph-up-arrow"></i> è³‡ç”¢æ¨æ¼”</h6>
                <div style="height: 250px;"><canvas id="predictionChart"></canvas></div>
            </div>
        </div>
    </div>

    <div class="pro-card mb-4">
        <ul class="nav nav-tabs mb-3" id="myTab">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#portfolio">ğŸ“Š æŒè‚¡ç›£æ§</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#heatmap">ğŸ”¥ å°è‚¡/ç¾è‚¡ç†±åŠ›åœ–</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#news">ğŸ“° å°è‚¡æ–°è</button></li>
        </ul>
        
        <div class="tab-content">
            <div class="tab-pane fade show active" id="portfolio">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>æ¨™çš„</th><th>åˆ†é¡</th><th>é…æ¯</th><th class="text-end">ç¾åƒ¹</th><th class="text-end">å¸‚å€¼</th><th class="text-end">æç›Š</th><th class="text-end">å¹´åŒ–%</th><th class="text-end">æ®–åˆ©ç‡%</th><th class="text-end">3Y Trend</th>
                            </tr>
                        </thead>
                        <tbody id="portfolioTableBody">
                            <tr><td colspan="9" class="text-center py-5 text-muted">Ready. Please load data.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-pane fade" id="heatmap">
                <div style="height: 500px;">
                    <div class="tradingview-widget-container">
                        <div class="tradingview-widget-container__widget"></div>
                        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-stock-heatmap.js" async>
                        {"exchanges":[],"dataSource":"SPX500","grouping":"sector","blockSize":"market_cap_basic","blockColor":"change","locale":"zh_TW","symbolUrl":"","colorTheme":"light","hasTopBar":false,"isTransparent":true,"width":"100%","height":"100%"}
                        </script>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="news">
                <div class="d-flex gap-2 mb-3 overflow-auto">
                    <a href="https://tw.stock.yahoo.com/news/" target="_blank" class="btn btn-sm btn-outline-primary rounded-pill px-3"><i class="bi bi-newspaper"></i> Yahooè‚¡å¸‚</a>
                    <a href="https://news.cnyes.com/news/cat/tw_stock" target="_blank" class="btn btn-sm btn-outline-danger rounded-pill px-3"><i class="bi bi-graph-up"></i> é‰…äº¨ç¶²å°è‚¡</a>
                    <a href="https://money.udn.com/money/index" target="_blank" class="btn btn-sm btn-outline-success rounded-pill px-3"><i class="bi bi-currency-dollar"></i> ç¶“æ¿Ÿæ—¥å ±</a>
                </div>

                <div style="height: 500px;">
                    <!-- ä¿®æ­£æ–°è Widgetï¼šæ”¹ç”¨å°ç©é›» (2330) ä½œç‚ºæ–°èä¾†æºï¼Œä¿è­‰æœ‰è³‡æ–™ -->
                    <div class="tradingview-widget-container">
                        <div class="tradingview-widget-container__widget"></div>
                        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-timeline.js" async>
                        {
                            "feedMode": "symbol",
                            "symbol": "TWSE:2330",
                            "colorTheme": "light",
                            "isTransparent": true,
                            "displayMode": "regular",
                            "width": "100%",
                            "height": "100%",
                            "locale": "zh_TW"
                        }
                        </script>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentTotalAssets = 0, chartInstance = null, pieChartInstance = null, isDark = false;

    window.onload = function() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') enableDark(true);
        const savedUrl = localStorage.getItem('sheetUrl');
        if (savedUrl) { document.getElementById('sheetUrl').value = savedUrl; loadData(); }
        const savedGoal = localStorage.getItem('fireGoal');
        if (savedGoal) document.getElementById('fireGoal').value = savedGoal;
    }

    function toggleTheme() { enableDark(!isDark); }
    function enableDark(enabled) {
        isDark = enabled;
        document.documentElement.setAttribute('data-bs-theme', enabled ? 'dark' : 'light');
        localStorage.setItem('theme', enabled ? 'dark' : 'light');
        if (chartInstance) { 
            chartInstance.options.scales.x.grid.color = enabled ? '#334155' : '#e2e8f0';
            chartInstance.options.scales.y.grid.color = enabled ? '#334155' : '#e2e8f0';
            chartInstance.update(); 
        }
    }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('show'); }

    function loadData() {
        const url = document.getElementById('sheetUrl').value.trim();
        if (!url) { alert("è«‹è¼¸å…¥ç¶²å€"); return; }
        localStorage.setItem('sheetUrl', url);
        Papa.parse(url, {
            download: true, header: true, skipEmptyLines: true,
            complete: function(results) { processPortfolio(results.data); }
        });
    }

    function processPortfolio(data) {
        const tbody = document.getElementById('portfolioTableBody');
        tbody.innerHTML = "";
        let totalMkt=0, totalCst=0, totalDiv=0, categories={};

        data.forEach(row => {
            if(row['Code']) {
                const mkVal = parseNum(row['MarketVal']);
                const prof = parseNum(row['Profit']);
                const type = row['Type'] || 'Other';
                const yieldPct = parseNum(row['Yield']);
                const estDiv = mkVal * (yieldPct / 100);
                const freq = row['Freq'] ? row['Freq'].trim() : 'å¹´';

                totalMkt += mkVal; totalCst += (mkVal - prof); totalDiv += estDiv;
                if(categories[type]) categories[type] += mkVal; else categories[type] = mkVal;

                let freqClass = 'bg-secondary';
                if(freq.includes('æœˆ')) freqClass = 'bg-danger';
                if(freq.includes('å­£')) freqClass = 'bg-primary';

                const tr = `<tr>
                    <td class="fw-bold text-primary mono-font">${row['Code']}</td>
                    <td><span class="badge bg-light text-dark border">${type}</span></td>
                    <td><span class="badge ${freqClass}">${freq}</span></td>
                    <td class="text-end mono-font">${parseFloat(row['Price']).toFixed(2)}</td>
                    <td class="text-end fw-bold mono-font">${Math.round(mkVal).toLocaleString()}</td>
                    <td class="text-end ${getColor(prof)} mono-font">${Math.round(prof).toLocaleString()}</td>
                    <td class="text-end ${getColor(parsePct(row['Annualized']))}">${formatPct(parsePct(row['Annualized']))}</td>
                    <td class="text-end text-muted">${yieldPct.toFixed(2)}%</td>
                    <td class="text-end ${getColor(parsePct(row['Return3Y']))}">${formatPct(parsePct(row['Return3Y']))}</td>
                </tr>`;
                tbody.innerHTML += tr;
            }
        });

        currentTotalAssets = totalMkt;
        document.getElementById('totalAssets').innerText = Math.round(totalMkt).toLocaleString();
        
        const tp = totalMkt - totalCst;
        document.getElementById('pnlCard').className = `pro-card border-start border-4 ${tp >= 0 ? 'border-success' : 'border-danger'}`;
        const profitEl = document.getElementById('totalProfit');
        profitEl.innerText = Math.round(tp).toLocaleString();
        profitEl.className = `kpi-value fs-3 fw-bold mono-font ${tp >= 0 ? 'text-success' : 'text-danger'}`;
        
        const tpPct = totalCst > 0 ? (tp/totalCst*100) : 0;
        const profitPctEl = document.getElementById('profitPct');
        profitPctEl.innerText = (tp>=0?'+':'') + tpPct.toFixed(2) + '%';
        profitPctEl.className = `small fw-bold ${tp >= 0 ? 'text-success' : 'text-danger'}`;

        document.getElementById('totalDividend').innerText = Math.round(totalDiv).toLocaleString();
        document.getElementById('avgYield').innerText = (totalMkt>0 ? (totalDiv/totalMkt*100) : 0).toFixed(2);

        const monthlyPassive = Math.round(totalDiv / 12);
        document.getElementById('monthlyPassive').innerText = monthlyPassive.toLocaleString();
        const passivePct = Math.min((monthlyPassive / 50000) * 100, 100);
        document.getElementById('passiveProgress').style.width = passivePct + '%';
        document.getElementById('passivePct').innerText = passivePct.toFixed(1);

        updateFireProgress();
        renderPieChart(categories);
        calculateProjection();
    }

    function updateFireProgress() {
        const goal = parseFloat(document.getElementById('fireGoal').value) || 20000000;
        localStorage.setItem('fireGoal', goal);
        const pct = Math.min((currentTotalAssets / goal) * 100, 100);
        const bar = document.getElementById('fireProgressBar');
        bar.style.width = pct + '%';
        document.getElementById('firePercent').innerText = pct.toFixed(2) + '%';
        if(pct<30) bar.className='progress-bar bg-danger'; else if(pct<70) bar.className='progress-bar bg-warning'; else bar.className='progress-bar bg-success';
    }

    function renderPieChart(categories) {
        const ctx = document.getElementById('allocationChart').getContext('2d');
        if(pieChartInstance) pieChartInstance.destroy();
        pieChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: Object.keys(categories), datasets: [{ data: Object.values(categories), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#64748b'], borderWidth: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: isDark?'#e2e8f0':'#1e293b' } } } }
        });
    }

    function calculateProjection() {
        const monthly = parseFloat(document.getElementById('monthlyContribute').value)||0;
        const rate = (parseFloat(document.getElementById('annualReturn').value)||0)/100;
        let labels=[], data=[], pv=currentTotalAssets||10000;
        for(let i=0; i<=20; i++){
            labels.push(i+'y');
            let fv = pv * Math.pow(1+rate, i) + (rate ? (monthly*12)*((Math.pow(1+rate,i)-1)/rate) : (monthly*12)*i);
            data.push(Math.round(fv));
        }
        const ctx = document.getElementById('predictionChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: [{ label: 'Asset Growth', data: data, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill:true, tension: 0.4 }] },
            options: { 
                responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} },
                scales: { x: { grid: { color: isDark?'#334155':'#e2e8f0' }, ticks: { color: isDark?'#94a3b8':'#64748b' } }, y: { grid: { color: isDark?'#334155':'#e2e8f0' }, ticks: { color: isDark?'#94a3b8':'#64748b' } } }
            }
        });
    }

    function parseNum(v) { return parseFloat(String(v).replace(/,/g,'')) || 0; }
    function parsePct(v) { if(!v || v==='-') return null; let n=parseFloat(String(v).replace('%','')); return String(v).includes('%')?n:n*100; }
    function formatPct(v) { return v===null?'-':v.toFixed(2)+'%'; }
    function getColor(v) { if(v===null) return ''; return v>=0?'text-success':'text-danger'; }
</script>
</body>
</html>
